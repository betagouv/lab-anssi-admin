#!/usr/bin/env bash

set -euo pipefail

db_name="$1"
db_id="$2"

tmp_dir="$(mktemp -d)"

GPG_HOME_DIR="${GPG_HOME_DIR:-$(mktemp -d)}"

import_pgp_keys() {
  gpg --homedir "${GPG_HOME_DIR}" --import <(echo "$PGP_KEYS") 2>/dev/null
}

list_keys() {
  gpg --homedir "${GPG_HOME_DIR}" --list-keys --with-colons | awk -F: '/^pub:/ {print $5}'
}

gpg_encrypt() {
  local recipients=""
  for key in $(list_keys)
  do
    recipients="$recipients --recipient $key"
  done

  gpg --homedir "${GPG_HOME_DIR}" --trust-model always --encrypt $recipients
}

dump_is_healthy() {
  local dump="$1"
  pg_restore --list "$dump" >/dev/null
}

import_pgp_keys

download > "$tmp_dir/$db_name"
dump_is_healthy "$tmp_dir/$db_name"
cat "$tmp_dir/$db_name" | gpg_encrypt | s3_push "${S3_URL}${db_name}.pgp"

rm -rf "$tmp_dir"
